# è‡ªå®šä¹‰è„šæœ¬ä½¿ç”¨æŒ‡å—

## âš ï¸ é‡è¦è¯´æ˜

ç»è¿‡ä»£ç åˆ†æï¼Œ**è‡ªå®šä¹‰è„šæœ¬åŠŸèƒ½ç›®å‰å­˜åœ¨ä¸¥é‡çš„å¯ç”¨æ€§é—®é¢˜**ã€‚è™½ç„¶ä»£ç æ¡†æ¶å·²ç»å®ç°ï¼Œä½†ç¼ºå°‘å…³é”®çš„æ–‡æ¡£å’Œç¤ºä¾‹ï¼Œå¯¼è‡´ç”¨æˆ·å‡ ä¹æ— æ³•æ­£ç¡®ä½¿ç”¨ã€‚

---

## ğŸ“‹ é—®é¢˜åˆ†æ

### 1. **ç¼ºå°‘ API æ–‡æ¡£**

ç”¨æˆ·åœ¨ç¼–å†™è‡ªå®šä¹‰è„šæœ¬æ—¶ï¼Œä¸çŸ¥é“å¯ä»¥è®¿é—®å“ªäº›å˜é‡å’Œæ–¹æ³•ï¼š

```javascript
// ç”¨æˆ·çœ‹åˆ°çš„ç•Œé¢ï¼šä¸€ä¸ªç©ºç™½çš„ä»£ç ç¼–è¾‘å™¨
// é—®é¢˜ï¼šç”¨æˆ·ä¸çŸ¥é“ context å¯¹è±¡åŒ…å«ä»€ä¹ˆï¼
```

### 2. **context å¯¹è±¡å†…å®¹ä¸æ˜ç¡®**

ä»ä»£ç åˆ†ææ¥çœ‹ï¼Œ`context` å¯¹è±¡åŒ…å«ï¼š

```javascript
const context = {
    currentCode: string,      // å½“å‰ç”»å¸ƒä¸Šçš„å»ºç­‘ä»£ç 
    userPrompt: string,       // ç”¨æˆ·çš„è¾“å…¥æç¤º
    imageUrl: string | null,  // å›¾ç‰‡ URLï¼ˆå¦‚æœæœ‰ï¼‰
    config: {                 // é…ç½®å¯¹è±¡
        customSkills: [],
        customScripts: [],
        officialScriptOverrides: {},
        // ... å…¶ä»–é…ç½®
    }
};
```

ä½†æ˜¯ï¼š
- âŒ æ²¡æœ‰æ–‡æ¡£è¯´æ˜è¿™äº›å­—æ®µ
- âŒ æ²¡æœ‰ç¤ºä¾‹å±•ç¤ºå¦‚ä½•ä½¿ç”¨
- âŒ æ²¡æœ‰è¯´æ˜è¿”å›å€¼æ ¼å¼

### 3. **ç¼ºå°‘å®ç”¨å·¥å…·**

è‡ªå®šä¹‰è„šæœ¬æ— æ³•è®¿é—®ï¼š
- âŒ `executeVoxelScript()` - æ‰§è¡Œå»ºç­‘ä»£ç çš„å‡½æ•°
- âŒ `VALID_BLOCKS_1_21` - æœ‰æ•ˆæ–¹å—åˆ—è¡¨
- âŒ ä»»ä½•å†…ç½®çš„è¾…åŠ©å‡½æ•°

è¿™æ„å‘³ç€ç”¨æˆ·éœ€è¦**ä»é›¶å¼€å§‹å®ç°æ‰€æœ‰åŠŸèƒ½**ã€‚

---

## ğŸ” å½“å‰å¯ç”¨çš„åŠŸèƒ½

### å®˜æ–¹å†…ç½®è„šæœ¬ï¼ˆå¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼‰

1. **analyzeScene** - åˆ†æåœºæ™¯è¾¹ç•Œ
2. **analyzeStructure** - æ£€æŸ¥å»ºç­‘è´¨é‡

è¿™äº›è„šæœ¬æ˜¯ç¡¬ç¼–ç åœ¨ `agentLoopV2.js` ä¸­çš„ï¼Œå¯ä»¥æ­£å¸¸å·¥ä½œã€‚

### è‡ªå®šä¹‰è„šæœ¬çš„æ‰§è¡Œæ–¹å¼

```javascript
// åœ¨ SettingsModal ä¸­æ·»åŠ è‡ªå®šä¹‰è„šæœ¬
const customScript = {
    id: 'my-script',
    name: 'æˆ‘çš„è„šæœ¬',
    description: 'è„šæœ¬æè¿°',
    content: `
        // âš ï¸ è¿™é‡Œæ˜¯ç”¨æˆ·éœ€è¦ç¼–å†™çš„ä»£ç 
        // ä½†ç”¨æˆ·ä¸çŸ¥é“å¯ä»¥ç”¨ä»€ä¹ˆï¼
        
        // context å‚æ•°åŒ…å«ï¼š
        // - context.currentCode: å½“å‰ä»£ç 
        // - context.userPrompt: ç”¨æˆ·è¾“å…¥
        // - context.imageUrl: å›¾ç‰‡URL
        // - context.config: é…ç½®å¯¹è±¡
        
        // args å‚æ•°æ˜¯ AI ä¼ é€’çš„å‚æ•°æ•°ç»„
        
        // å¿…é¡»è¿”å›ä¸€ä¸ªå¯¹è±¡
        return {
            success: true,
            result: { /* ä½ çš„ç»“æœ */ }
        };
    `
};
```

---

## ğŸ’¡ å»ºè®®çš„æ”¹è¿›æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šæ·»åŠ å®Œæ•´çš„ API æ–‡æ¡£

åˆ›å»º `docs/è‡ªå®šä¹‰è„šæœ¬APIæ–‡æ¡£.md`ï¼ŒåŒ…å«ï¼š

1. **context å¯¹è±¡å®Œæ•´è¯´æ˜**
   ```javascript
   {
       currentCode: string,      // å½“å‰å»ºç­‘ä»£ç ï¼ˆå®Œæ•´çš„ JavaScriptï¼‰
       userPrompt: string,       // ç”¨æˆ·çš„æ–‡å­—æè¿°
       imageUrl: string | null,  // å‚è€ƒå›¾ç‰‡ URL
       config: object           // å®Œæ•´çš„é…ç½®å¯¹è±¡
   }
   ```

2. **è¿”å›å€¼æ ¼å¼è§„èŒƒ**
   ```javascript
   // æˆåŠŸ
   return { success: true, result: { /* æ•°æ® */ } };
   
   // å¤±è´¥
   return { success: false, error: "é”™è¯¯ä¿¡æ¯" };
   ```

3. **å®Œæ•´ç¤ºä¾‹**
   ```javascript
   // ç¤ºä¾‹ï¼šç»Ÿè®¡æ–¹å—æ•°é‡
   const code = context.currentCode;
   const blockCount = (code.match(/builder\.set/g) || []).length;
   return {
       success: true,
       result: {
           totalBlocks: blockCount,
           message: `æ‰¾åˆ° ${blockCount} ä¸ªæ–¹å—`
       }
   };
   ```

### æ–¹æ¡ˆ 2ï¼šæä¾›è¾…åŠ©å‡½æ•°åº“

åœ¨è„šæœ¬æ‰§è¡Œæ—¶æ³¨å…¥å¸¸ç”¨å·¥å…·ï¼š

```javascript
// ä¿®æ”¹ agentLoopV2.js ä¸­çš„æ‰§è¡Œä»£ç 
const scriptFn = new Function('context', 'args', 'utils', customScript.content);
const result = scriptFn(context, scriptArgs, {
    executeVoxelScript,  // æ‰§è¡Œå»ºç­‘ä»£ç 
    VALID_BLOCKS_1_21,   // æœ‰æ•ˆæ–¹å—åˆ—è¡¨
    addLineNumbers,      // æ·»åŠ è¡Œå·
    // ... å…¶ä»–å·¥å…·å‡½æ•°
});
```

### æ–¹æ¡ˆ 3ï¼šæ·»åŠ å†…ç½®ç¤ºä¾‹è„šæœ¬

åœ¨è®¾ç½®ç•Œé¢ä¸­æä¾›"ç¤ºä¾‹è„šæœ¬"æŒ‰é’®ï¼Œä¸€é”®æ’å…¥å¸¸ç”¨æ¨¡æ¿ï¼š

```javascript
// ç¤ºä¾‹ 1ï¼šç»Ÿè®¡æ–¹å—ç±»å‹
const blocks = {};
const matches = context.currentCode.matchAll(/builder\.set\([^,]+,[^,]+,[^,]+,\s*['"]([^'"]+)['"]/g);
for (const match of matches) {
    const blockType = match[1];
    blocks[blockType] = (blocks[blockType] || 0) + 1;
}
return { success: true, result: { blockTypes: blocks } };

// ç¤ºä¾‹ 2ï¼šæ£€æŸ¥æ˜¯å¦æœ‰é—¨
const hasDoor = context.currentCode.includes('door');
return {
    success: true,
    result: {
        hasDoor,
        message: hasDoor ? 'å»ºç­‘æœ‰é—¨' : 'å»ºç­‘æ²¡æœ‰é—¨'
    }
};

// ç¤ºä¾‹ 3ï¼šè·å–å»ºç­‘å°ºå¯¸ï¼ˆéœ€è¦è§£æä»£ç ï¼‰
// è¿™ä¸ªæ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦æ‰§è¡Œä»£ç æˆ–æ­£åˆ™åŒ¹é…
```

---

## ğŸ¯ ç»“è®º

### å½“å‰çŠ¶æ€ï¼šâŒ **ä¸æ¨èç”¨æˆ·ä½¿ç”¨è‡ªå®šä¹‰è„šæœ¬**

åŸå› ï¼š
1. æ²¡æœ‰æ–‡æ¡£è¯´æ˜å¯ç”¨çš„ API
2. æ²¡æœ‰ç¤ºä¾‹ä»£ç å‚è€ƒ
3. ç¼ºå°‘å¿…è¦çš„è¾…åŠ©å·¥å…·
4. ç”¨æˆ·éœ€è¦å®Œå…¨é çŒœæµ‹æ¥ç¼–å†™ä»£ç 

### å®˜æ–¹è„šæœ¬ï¼šâœ… **å¯ä»¥æ­£å¸¸ä½¿ç”¨**

- `analyzeScene` - åˆ†æåœºæ™¯è¾¹ç•Œ
- `analyzeStructure` - æ£€æŸ¥å»ºç­‘è´¨é‡

è¿™ä¸¤ä¸ªè„šæœ¬æ˜¯ç¡¬ç¼–ç çš„ï¼ŒåŠŸèƒ½å®Œæ•´ä¸”å¯é ã€‚

### å»ºè®®ï¼š

**å¯¹äºå¼€å‘è€…ï¼š**
1. æ·»åŠ å®Œæ•´çš„ API æ–‡æ¡£
2. æä¾›è‡³å°‘ 3-5 ä¸ªç¤ºä¾‹è„šæœ¬
3. åœ¨è®¾ç½®ç•Œé¢ä¸­æ·»åŠ "å¸®åŠ©"æŒ‰é’®ï¼Œé“¾æ¥åˆ°æ–‡æ¡£
4. è€ƒè™‘æä¾›è„šæœ¬æ¨¡æ¿é€‰æ‹©å™¨

**å¯¹äºç”¨æˆ·ï¼š**
1. ç›®å‰åªä½¿ç”¨å®˜æ–¹å†…ç½®çš„è„šæœ¬
2. å¦‚æœéœ€è¦è‡ªå®šä¹‰åŠŸèƒ½ï¼Œå»ºè®®ç›´æ¥ä¿®æ”¹ `agentLoopV2.js` æ·»åŠ ç¡¬ç¼–ç è„šæœ¬
3. ç­‰å¾…å®˜æ–¹å®Œå–„è‡ªå®šä¹‰è„šæœ¬çš„æ–‡æ¡£å’Œå·¥å…·

---

## ğŸ“ é™„å½•ï¼šå¦‚ä½•æŸ¥çœ‹ context å¯¹è±¡

å¦‚æœä½ æƒ³çŸ¥é“ context åˆ°åº•åŒ…å«ä»€ä¹ˆï¼Œå¯ä»¥è¿™æ ·æµ‹è¯•ï¼š

```javascript
// åœ¨è‡ªå®šä¹‰è„šæœ¬ä¸­å†™å…¥ï¼š
return {
    success: true,
    result: {
        contextKeys: Object.keys(context),
        currentCodeLength: context.currentCode?.length || 0,
        userPrompt: context.userPrompt,
        hasImage: !!context.imageUrl,
        configKeys: Object.keys(context.config || {})
    }
};
```

ç„¶ååœ¨ AI ç”Ÿæˆæ—¶è°ƒç”¨è¿™ä¸ªè„šæœ¬ï¼ŒæŸ¥çœ‹è¿”å›çš„ç»“æœã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 1.0  
**æœ€åæ›´æ–°ï¼š** 2026-01-13  
**ä½œè€…ï¼š** Kiro AI åˆ†æ
